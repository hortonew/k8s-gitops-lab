apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: promtail
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: promtail
    targetRevision: 6.16.6
    helm:
      valuesObject:
        # DaemonSet configuration - runs on every node
        daemonset:
          enabled: true

        # Resource limits for lab environment
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 64Mi

        # Promtail configuration
        config:
          # Loki endpoint
          clients:
          - url: http://loki.loki.svc.cluster.local:3100/loki/api/v1/push
          # Positions file to track what's been read
          positions:
            filename: /run/promtail/positions.yaml

          # Server configuration
          server:
            http_listen_port: 3101

          # Scrape configs for collecting logs
          scrape_configs:
          # Scrape all pod logs
          - job_name: kubernetes-pods
            pipeline_stages:
            - cri: {}
            kubernetes_sd_configs:
            - role: pod
            relabel_configs:
            # Add namespace label
            - source_labels:
              - __meta_kubernetes_pod_node_name
              target_label: node_name
            - source_labels:
              - __meta_kubernetes_namespace
              target_label: namespace
            # Add pod name label
            - source_labels:
              - __meta_kubernetes_pod_name
              target_label: pod
            # Add container name label
            - source_labels:
              - __meta_kubernetes_pod_container_name
              target_label: container
            # Add pod labels as Loki labels
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            # Set log path
            - source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
              target_label: __path__
              separator: /
              replacement: /var/log/pods/*$1/*.log

        # Service monitor for Prometheus
        serviceMonitor:
          enabled: true
          labels:
            release: prometheus

        # Mount host paths to read container logs
        defaultVolumes:
        - name: run
          hostPath:
            path: /run/promtail
        - name: containers
          hostPath:
            path: /var/lib/docker/containers
        - name: pods
          hostPath:
            path: /var/log/pods

        defaultVolumeMounts:
        - name: run
          mountPath: /run/promtail
        - name: containers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: pods
          mountPath: /var/log/pods
          readOnly: true

  destination:
    server: https://kubernetes.default.svc
    namespace: loki

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
